<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapitulasi Tadarus Ramadan</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { max-width: 600px; margin: auto; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="text-center">Rekapitulasi Tadarus Ramadan</h2>
        <form id="tadarusForm" class="mt-3">
            <div class="mb-3">
                <label for="waktuSalat" class="form-label">Waktu Salat:</label>
                <select id="waktuSalat" class="form-select">
                    <option>Subuh</option>
                    <option>Dzuhur</option>
                    <option>Ashar</option>
                    <option>Maghrib</option>
                    <option>Isya</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="jumlahHalaman" class="form-label">Jumlah Halaman:</label>
                <input type="number" id="jumlahHalaman" class="form-control" min="1" max="10" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Simpan</button>
        </form>
        
        <h3 class="mt-4 text-center">Pilih Tanggal</h3>
        <input type="date" id="filterTanggal" class="form-control mt-2">
        
        <h3 class="mt-4 text-center">Rekap Harian</h3>
        <p class="text-center" id="tanggalHarian"></p>
        <div class="table-responsive">
            <table class="table table-bordered mt-3 text-center">
                <thead>
                    <tr>
                        <th>Waktu Salat</th>
                        <th>Jumlah Halaman</th>
                    </tr>
                </thead>
                <tbody id="rekapTable"></tbody>
            </table>
        </div>
        
        <h3 class="mt-4 text-center">Grafik Progres</h3>
        <canvas id="progressChart" class="mt-3"></canvas>
    </div>
    
    <script>
        const form = document.getElementById("tadarusForm");
        const tableBody = document.getElementById("rekapTable");
        const ctx = document.getElementById("progressChart").getContext("2d");
        const tanggalHarian = document.getElementById("tanggalHarian");
        const filterTanggal = document.getElementById("filterTanggal");
        let dataTadarus = JSON.parse(localStorage.getItem("tadarus")) || [];
        let chartInstance = null; // Simpan referensi ke chart

        // Fungsi untuk menyimpan data tanpa duplikasi waktu salat
        form.addEventListener("submit", function(event) {
            event.preventDefault();
            const waktu = document.getElementById("waktuSalat").value;
            const jumlah = parseInt(document.getElementById("jumlahHalaman").value);
            const today = filterTanggal.value || new Date().toISOString().split("T")[0];

            // Cek apakah data untuk waktu salat tersebut sudah ada
            let dataHariIni = dataTadarus.filter(item => item.tanggal === today);
            let existingEntry = dataHariIni.find(item => item.waktu === waktu);

            if (existingEntry) {
                // Jika sudah ada, update jumlah halaman
                existingEntry.jumlah = jumlah;
            } else {
                // Jika belum ada, tambahkan data baru
                dataTadarus.push({ tanggal: today, waktu, jumlah });
            }

            localStorage.setItem("tadarus", JSON.stringify(dataTadarus));
            tampilkanData(today);
        });

        // Event listener untuk filter tanggal
        filterTanggal.addEventListener("change", function() {
            tampilkanData(filterTanggal.value);
        });

        // Fungsi untuk menampilkan data harian berdasarkan tanggal
        function tampilkanData(tanggal) {
            tableBody.innerHTML = "";
            let total = 0;
            tanggalHarian.innerText = `Tanggal: ${tanggal}`;

            let dataHariIni = dataTadarus.filter(item => item.tanggal === tanggal);

            dataHariIni.forEach((item) => {
                total += item.jumlah;
                tableBody.innerHTML += `<tr><td>${item.waktu}</td><td>${item.jumlah}</td></tr>`;
            });

            updateChart(total);
        }

        // Fungsi untuk memperbarui grafik dengan data baru
        function updateChart(total) {
            if (chartInstance) {
                chartInstance.destroy(); // Hapus chart lama sebelum membuat yang baru
            }

            chartInstance = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["Target 1 Juz"],
                    datasets: [{
                        label: "Progres Harian",
                        data: [total],
                        backgroundColor: total >= 20 ? "green" : "orange"
                    }]
                }
            });
        }

        // Set tanggal awal ke hari ini dan tampilkan data
        const today = new Date().toISOString().split("T")[0];
        filterTanggal.value = today;
        tampilkanData(today);
    </script>
</body>
</html>
